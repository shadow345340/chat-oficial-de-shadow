
    
    <!DOCTYPE html>
<html lang="es" data-theme="blue">
<head>
    <meta name="robots" content="noindex, nofollow">
    <meta charset="UTF-8">
    <title>Shadow Messenger</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --bg: #0b0e11; --side: #15191c; --accent: #007bff; --text: #ffffff;
        }
        [data-theme="purple"] { --accent: #8a2be2; }
        [data-theme="gray"] { --accent: #4a4a4a; }

        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 300px; background: var(--side); border-right: 1px solid #333; display: flex; flex-direction: column; }
        .header { padding: 20px; background: var(--accent); font-weight: bold; display: flex; justify-content: space-between; }
        .contact { padding: 15px; border-bottom: 1px solid #222; cursor: pointer; transition: 0.3s; }
        .contact:hover { background: #2a2e33; }

        /* Chat Area */
        .main { flex: 1; display: flex; flex-direction: column; }
        #chat-window { flex: 1; padding: 20px; overflow-y: auto; background: url('https://www.transparenttextures.com/patterns/carbon-fibre.png'); }
        
        .msg { margin-bottom: 10px; max-width: 70%; padding: 10px; border-radius: 10px; position: relative; }
        .sent { background: var(--accent); align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; }
        .received { background: #333; align-self: flex-start; border-bottom-left-radius: 2px; }
        
        .input-area { padding: 20px; background: var(--side); display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border-radius: 25px; border: none; background: #2a2e33; color: white; outline: none; }
        button { background: var(--accent); border: none; padding: 10px 20px; border-radius: 25px; color: white; cursor: pointer; }
        
        select { background: transparent; color: white; border: 1px solid white; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="header">
            Shadow
            <select onchange="document.documentElement.setAttribute('data-theme', this.value)">
                <option value="blue">Azul</option>
                <option value="purple">Violeta</option>
                <option value="gray">Gris</option>
            </select>
        </div>
        <div style="padding: 10px;">
            <input type="text" id="search-input" placeholder="Buscar usuarios..." onkeyup="searchUsers()">
            <div id="search-results"></div>
        </div>
        <div id="contacts-list">
            {% for c in contacts %}
            <div class="contact" onclick="openChat({{ c.id }}, '{{ c.username }}')">{{ c.username }}</div>
            {% endfor %}
        </div>
        <a href="/logout" style="color: gray; padding: 20px; text-decoration: none; font-size: 12px;">Cerrar Sesi√≥n</a>
    </div>

    <div class="main">
        <div id="chat-header" style="padding: 15px; background: var(--side); border-bottom: 1px solid #333;">Selecciona un contacto</div>
        <div id="chat-window"></div>
        <div class="input-area">
            <input type="text" id="msg-input" placeholder="Escribe un mensaje seguro...">
            <button onclick="sendMessage()">Enviar</button>
        </div>
    </div>

    <script>
        const socket = io();
        let activeId = null;
        const SECRET = "Llave_Maestra_Shadow_2025";

        function searchUsers() {
            let q = document.getElementById('search-input').value;
            if(q.length < 2) return;
            fetch('/search', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({query:q})})
            .then(r => r.json()).then(data => {
                let html = '';
                data.forEach(u => html += `<div class="contact" onclick="addContact(${u.id})">+ ${u.username}</div>`);
                document.getElementById('search-results').innerHTML = html;
            });
        }

        function addContact(id) {
            fetch('/add_contact', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:id})})
            .then(() => location.reload());
        }

        function openChat(id, name) {
            activeId = id;
            document.getElementById('chat-header').innerText = "Chat con " + name;
            document.getElementById('chat-window').innerHTML = '';
            fetch('/history/' + id).then(r => r.json()).then(data => {
                data.forEach(m => {
                    let dec = CryptoJS.AES.decrypt(m.msg, SECRET).toString(CryptoJS.enc.Utf8);
                    displayMsg(dec, m.sender_id == {{ user.id }}, m.hora);
                });
            });
        }

        function sendMessage() {
            let input = document.getElementById('msg-input');
            if(!activeId || !input.value) return;
            let enc = CryptoJS.AES.encrypt(input.value, SECRET).toString();
            socket.emit('message', {target_id: activeId, msg: enc});
            input.value = '';
        }

        socket.on('new_msg', data => {
            if(activeId) {
                let dec = CryptoJS.AES.decrypt(data.msg, SECRET).toString(CryptoJS.enc.Utf8);
                displayMsg(dec, data.sender_id == {{ user.id }}, data.hora);
            }
        });

        function displayMsg(text, isSent, hora) {
            let win = document.getElementById('chat-window');
            let div = document.createElement('div');
            div.className = 'msg ' + (isSent ? 'sent' : 'received');
            div.innerHTML = `<div>${text}</div><small style="font-size:10px; opacity:0.7">${hora}</small>`;
            win.appendChild(div);
            win.scrollTop = win.scrollHeight;
        }
    </script>
</body>
</html>
</html>
