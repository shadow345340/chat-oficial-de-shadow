<!DOCTYPE html>
<html lang="es" data-theme="blue">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow">
    
    <title>Mathias Messenger</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root { --bg: #0f172a; --side: #1e293b; --accent: #3b82f6; --text: #f8fafc; }
        [data-theme="purple"] { --accent: #a855f7; }
        [data-theme="green"] { --accent: #10b981; }

        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100dvh; overflow: hidden; }

        .sidebar { width: 300px; background: var(--side); display: flex; flex-direction: column; border-right: 1px solid #334155; transition: 0.3s; z-index: 1000; }
        
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -300px; height: 100%; }
            .sidebar.active { left: 0; }
        }

        .header-side { padding: 20px; background: rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #334155; }
        .contact-list { flex: 1; overflow-y: auto; }
        .contact-item { padding: 15px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid #ffffff05; }
        .contact-item:hover { background: rgba(255,255,255,0.05); }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }

        .main { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }
        .top-nav { padding: 10px 20px; background: var(--side); display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #334155; height: 60px; box-sizing: border-box; }
        
        #chat-window { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .msg { padding: 12px 16px; border-radius: 18px; max-width: 75%; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .sent { align-self: flex-end; background: var(--accent); border-bottom-right-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .received { align-self: flex-start; background: #334155; border-bottom-left-radius: 4px; }

        .input-area { padding: 15px; background: var(--side); display: flex; gap: 10px; align-items: center; }
        .input-area input { flex: 1; padding: 12px 18px; border-radius: 25px; border: 1px solid #475569; background: #0f172a; color: white; outline: none; }
        
        #config-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; z-index: 2000; justify-content: center; align-items: center; }
        .config-box { background: var(--side); padding: 30px; border-radius: 20px; width: 85%; max-width: 380px; text-align: center; }
        
        .menu-btn { background: none; border: none; color: white; cursor: pointer; display: flex; align-items: center; padding: 5px; }
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div class="header-side">
            <div class="avatar">{{ user.username[0]|upper }}</div>
            <div style="overflow: hidden; text-overflow: ellipsis;"><b>{{ user.username }}</b></div>
        </div>
        <div class="contact-list">
            <div class="contact-item" onclick="openChat(0, 'Sistema')">
                <div class="avatar" style="background: #64748b;">S</div>
                <span>Soporte / Sistema</span>
            </div>
            {% for c in contacts %}
            <div class="contact-item" onclick="openChat({{ c.id }}, '{{ c.username }}')">
                <div class="avatar" style="opacity: 0.8;">{{ c.username[0]|upper }}</div>
                <span>{{ c.username }}</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="main">
        <div class="top-nav">
            <button class="menu-btn" onclick="toggleSidebar()"><span class="material-icons">menu</span></button>
            <b id="target-name">Bienvenido</b>
            <button class="menu-btn" style="margin-left: auto;" onclick="toggleConfig()"><span class="material-icons">settings</span></button>
        </div>

        <div id="chat-window">
            <div style="text-align: center; color: #64748b; font-size: 13px; margin-top: 20px;">
                Selecciona un contacto para iniciar una conversación cifrada.
            </div>
        </div>

        <div class="input-area">
            <span class="material-icons" style="color: #94a3b8; cursor:pointer;">add_circle</span>
            <input type="text" id="msg-input" placeholder="Escribe un mensaje..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button class="menu-btn" onclick="sendMessage()" style="color: var(--accent);"><span class="material-icons">send</span></button>
        </div>
    </div>

    <div id="config-overlay" onclick="toggleConfig()">
        <div class="config-box" onclick="event.stopPropagation()">
            <h3 style="margin-top:0; color: var(--accent);">Panel de Control</h3>
            <hr style="border: 0; border-top: 1px solid #334155; margin: 20px 0;">
            
            <label style="display:block; text-align:left; margin-bottom:5px;">Personalizar Tema:</label>
            <select onchange="document.documentElement.setAttribute('data-theme', this.value)" style="width:100%; padding:12px; background:#0f172a; color:white; border:1px solid #475569; border-radius:10px; margin-bottom:20px;">
                <option value="blue">Azul Galaxia (Default)</option>
                <option value="purple">Violeta Neón</option>
                <option value="green">Verde Esmeralda</option>
            </select>

            <div style="text-align:left; font-size:14px; color:#94a3b8; margin-bottom:25px;">
                <p><b>Usuario:</b> {{ user.username }}</p>
                <p><b>Seguridad:</b> Cifrado AES-256 Activado</p>
                <p><b>Privacidad:</b> Invisible para buscadores</p>
            </div>

            <button onclick="location.href='/logout'" style="width:100%; padding:12px; background:#ef4444; border:none; color:white; border-radius:10px; font-weight:bold; cursor:pointer;">Cerrar Sesión</button>
        </div>
    </div>

    <script>
        const socket = io();
        let activeId = null;
        const SECRET = "Llave_Maestra_Mathias";

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
        function toggleConfig() { 
            let el = document.getElementById('config-overlay');
            el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
        }

        function openChat(id, name) {
            activeId = id;
            document.getElementById('target-name').innerText = name;
            if(window.innerWidth < 768) {
                document.getElementById('sidebar').classList.remove('active');
            }
            document.getElementById('chat-window').innerHTML = '';
            
            fetch('/history/' + id).then(r => r.json()).then(data => {
                data.forEach(m => {
                    try {
                        let dec = CryptoJS.AES.decrypt(m.msg, SECRET).toString(CryptoJS.enc.Utf8);
                        drawMsg(dec || "[Mensaje de Sistema]", m.sender_id == {{ user.id }});
                    } catch(e) {
                        drawMsg("Contenido Cifrado", m.sender_id == {{ user.id }});
                    }
                });
            });
        }

        function sendMessage() {
            let inp = document.getElementById('msg-input');
            if(!activeId || !inp.value) return;
            let enc = CryptoJS.AES.encrypt(inp.value, SECRET).toString();
            socket.emit('message', {target_id: activeId, msg: enc});
            inp.value = '';
        }

        socket.on('new_msg', data => {
            if(activeId && (data.sender_id == activeId || data.sender_id == {{ user.id }})) {
                let dec = CryptoJS.AES.decrypt(data.msg, SECRET).toString(CryptoJS.enc.Utf8);
                drawMsg(dec, data.sender_id == {{ user.id }});
            }
            if(data.sender_id != {{ user.id }} && Notification.permission === "granted") {
                new Notification("Mathias Chat: Nuevo mensaje");
            }
        });

        function drawMsg(txt, isMe) {
            let win = document.getElementById('chat-window');
            let d = document.createElement('div');
            d.className = 'msg ' + (isMe ? 'sent' : 'received');
            d.innerText = txt;
            win.appendChild(d);
            win.scrollTop = win.scrollHeight;
        }

        if(Notification.permission !== "denied") Notification.requestPermission();
    </script>
</body>
</html>
