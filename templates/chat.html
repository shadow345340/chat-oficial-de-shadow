<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Shadow</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        :root { --bg: #050505; --neon: #00d2ff; --panel: #111; --txt: #e0e0e0; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--txt); display: flex; height: 100vh; }
        .side { width: 280px; background: var(--panel); border-right: 1px solid #222; display: flex; flex-direction: column; }
        .side h2 { padding: 20px; color: var(--neon); text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid #222; margin: 0; }
        .user { padding: 15px; cursor: pointer; border-bottom: 1px solid #1a1a1a; transition: 0.3s; }
        .user:hover { background: #1a1a1a; color: var(--neon); }
        .main { flex: 1; display: flex; flex-direction: column; background: #000; }
        #win { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 12px; max-width: 75%; line-height: 1.4; }
        .sent { align-self: flex-end; background: var(--neon); color: #000; font-weight: 500; }
        .recv { align-self: flex-start; background: #222; color: var(--txt); }
        .input-bar { padding: 20px; display: flex; gap: 10px; background: var(--panel); }
        input { flex: 1; background: #000; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; outline: none; }
        input:focus { border-color: var(--neon); }
        button { background: var(--neon); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-vault { margin-top: auto; padding: 15px; text-align: center; background: #1a1a1a; color: var(--neon); text-decoration: none; font-size: 13px; }
    </style>
</head>
<body>
    <div class="side">
        <h2>Shadow</h2>
        <div class="user" onclick="select('Sistema')"><b>[SISTEMA]</b></div>
        {% for u in users %}
        <div class="user" onclick="select('{{ u.username }}')">{{ u.username }}</div>
        {% endfor %}
        <a href="/vault" class="btn-vault">ðŸ”’ MI BÃ“VEDA</a>
        <a href="/logout" style="padding: 15px; color: #555; text-decoration: none; font-size: 12px;">Cerrar SesiÃ³n</a>
    </div>
    <div class="main">
        <div style="padding: 15px; border-bottom: 1px solid #222; font-weight: bold; color: var(--neon);" id="cur">Chat</div>
        <div id="win"></div>
        <div class="input-bar">
            <input type="text" id="in" placeholder="Escribir mensaje...">
            <button onclick="send()">ENVIAR</button>
        </div>
    </div>
    <script>
        const socket = io();
        let active = "";
        const me = "{{ me }}";
        function select(u) {
            active = u; document.getElementById('cur').innerText = active; document.getElementById('win').innerHTML = "";
            fetch('/h/'+u).then(r=>r.json()).then(data=> data.forEach(m=> draw(m.c, m.s==me)));
        }
        function send() {
            let i = document.getElementById('in');
            if(!active || !i.value) return;
            socket.emit('send_msg', {to: active, msg: i.value});
            i.value = "";
        }
        socket.on('recv_msg', d => { if((d.from==me && d.to==active) || (d.from==active && d.to==me)) draw(d.msg, d.from==me); });
        function draw(t, m) {
            let w = document.getElementById('win'); let d = document.createElement('div');
            d.className = 'msg ' + (m ? 'sent' : 'recv'); d.innerText = t;
            w.appendChild(d); w.scrollTop = w.scrollHeight;
        }
    </script>
</body>
</html>
